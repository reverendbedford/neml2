<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NEML2: Model Development</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams','[tex]/physics']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams','physics']
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NEML2<span id="projectnumber">&#160;1.4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('devel.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Model Development</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md8">Naming conventions</a></li>
<li class="level1"><a href="#autotoc_md9">Tutorial 1: Variable declaration and registration</a></li>
<li class="level1"><a href="#autotoc_md10">Tutorial 2: Parameter declaration and registraion</a></li>
<li class="level1"><a href="#autotoc_md11">Tutorial 3: Testing</a></li>
</ul>
</div>
<div class="textblock"><p>This tutorial serves as a developer-facing step-by-step guide for creating, testing, and using a constitutive model. A simple small deformation \(J_2\) viscoplasticity model with isotropic hardening is used as the example in this tutorial. For convenience, the mathematical equations for the constitutive model are summarized below  </p><p class="formulaDsp">
\begin{align*}
  \mathbf{M} &amp;= \mathbf{\sigma}, \\
  \bar{\sigma} &amp;= \frac{3}{2} \lVert \operatorname{dev}(\mathbf{M}) \rVert, \\
  k &amp;= H \bar{\varepsilon}^p, \\
  f^p &amp;= \bar{\sigma} - \sigma_y - k, \\
  \mathbf{N}_M &amp;= \partial f^p / \partial \mathbf{M}, \\
  N_k &amp;= \partial f^p / \partial k, \\
  \dot{\gamma} &amp;= \left( \frac{\abs{f^p}}{\eta} \right)^n \operatorname{heav}\left( f^p \right), \\
  \dot{\mathbf{\varepsilon}}^p &amp;= \dot{\gamma} \mathbf{N}_M, \\
  \dot{\bar{\varepsilon}}^p &amp;= \dot{\gamma} N_k, \\
  \dot{\mathbf{\varepsilon}} &amp;= \frac{\mathbf{\varepsilon} - \mathbf{\varepsilon}_n}{t - t_n}, \\
  \dot{\mathbf{\varepsilon}}^e &amp;= \dot{\mathbf{\varepsilon}} - \dot{\mathbf{\varepsilon}}^p, \\
  \dot{\mathbf{\sigma}} &amp;= K \operatorname{vol}\left( \dot{\mathbf{\varepsilon}}^e \right) + G\operatorname{dev}\left( \dot{\mathbf{\varepsilon}}^e \right), \\
  \mathbf{r} &amp;=
  \begin{Bmatrix}
    \mathbf{\sigma} - \mathbf{\sigma}_n - \dot{\mathbf{\sigma}} (t - t_n) \\
    \bar{\varepsilon}^p - \bar{\varepsilon}^p_n - \dot{\bar{\varepsilon}}^p (t - t_n)
  \end{Bmatrix}, \\
  \left( \mathbf{\sigma}, \bar{\varepsilon}^p \right) &amp;= \operatorname{sol}\left( \mathbf{r} = \mathbf{0} \right).
\end{align*}
</p>
<p> where \(\mathbf{\sigma}\) is the Cauchy stress, \(\mathbf{M}\) is the Mandel stress, \(\bar{\sigma}\) is the effective stress, \(\bar{\varepsilon}^p\) is the equivalent plastic strain, \(k\) is the isotropic hardening, \(f^p\) is the plastic yield function, \(\mathbf{N}_M\) is the plastic flow direction, \(N_k\) is the isotropic hardening direction, \(\dot{\gamma}\) is the plastic flow rate, \(\mathbf{\varepsilon}^p\) is the plastic strain, \(\mathbf{\varepsilon}\) is the strain, \(t\) is the time, and \(\mathbf{\varepsilon}^e\) is the elastic strain.</p>
<p>Each of the equation above is a function mapping some input variables to some output variables, hence can be defined as a NEML2 model. The example constitutive model under consideration is the composition of these models. Recall that the input variables of a composed model is the set of root input variables, and the output variables of a composed model is the set of leaf output variables. By inspection, the input variables for this composed model are  </p><p class="formulaDsp">
\[
  \mathbf{\varepsilon}, t, \mathbf{\varepsilon}_n, t_n, \mathbf{\sigma}_n, \bar{\varepsilon}^p_n,
\]
</p>
<p> and the output variables for this composed model are  </p><p class="formulaDsp">
\[
  \mathbf{\sigma}, \bar{\varepsilon}^p.
\]
</p>
<p>Finally, a constitutive model is completely defined up to a set of <em>parameters</em>. In this example, the parameters of the composed model under consideration are  </p><p class="formulaDsp">
\[
  H, \sigma_y, \eta, n, K, G.
\]
</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Naming conventions</h1>
<p>Recall that NEML2 models operates on <em>labeled tensors</em>, and that the collection of labels (with their corresponding layout) is called an labeled axis (<a class="el" href="classneml2_1_1LabeledAxis.html">LabeledAxis</a>). NEML2 predefines 6 sub-axes to categorize all the input, output and intermediate variables:</p><ul>
<li>State \(\mathcal{S}\): Variables on the "state" sub-axis collectively characterize the current <em>state</em> of the material subject to given external forces. The state variables are usually the output of a physically meaningful constitutive model.</li>
<li>Forces \(\mathcal{F}\): Variables on the "forces" sub-axis define the <em>external</em> forces that drive the response of the material.</li>
<li>Old state \(\mathcal{S}_n\): The state variables <em>prior to</em> the current constitutive update. In the time-discrete setting, these are the state variables from the previous time step.</li>
<li>Old forces \(\mathcal{F}_n\): The external forces <em>prior to</em> the current constitutive update. In the time-discrete setting, these are the forces from the previous time step.</li>
<li>Residual \(\mathcal{R}\): The residual defines an <em>implicit</em> model/function. An implicit model is updated by solving for the state variables that result in zero residual.</li>
<li>Trial state \(\tilde{\mathcal{S}}\): The state variables during an implicit update that result in a nonzero residual.</li>
</ul>
<p>In NEML2, the following naming conventions are recommended:</p><ul>
<li>User-facing variables and parameters should be <em>as descriptive as possible</em>. For example, the equivalent plastic strain is named "equivalent_plastic_strain". Note that white spaces, quotes, and left slashes are not allowed in the names. Underscores are recommended as an replacement for white spaces.</li>
<li>Developer-facing variables and parameters should use simple alphanumeric symbols. For example, the equivalent plastic strain is named "ep" in consistency with most of the existing literature.</li>
<li>Developner-facing member variables and parameters should use the same alphanumeric symbols. For example, the member variable for the equivalent plastic strain is named <code>ep</code>. However, if the member variable is protected or private, it is recommended to prefix it with an underscore, i.e. <code>_ep</code>.</li>
<li>Struct names and class names should use <code>PascalCase</code>.</li>
<li>Function names should use <code>snake_case</code>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md9"></a>
Tutorial 1: Variable declaration and registration</h1>
<p>The development of every model begins with the declaration and registration of its input and output variables. Here, we first define an abstract base class that will be later used to define the linear isotropic hardening relation. The abstract base class defines the isotropic hardening relation  </p><p class="formulaDsp">
\[
  k = f\left( \bar{\varepsilon}^p \right),
\]
</p>
<p> mapping the equivalent plastic strain to the isotropic hardening. Recall that NEML2 emphasizes modularity, and so the definition of this model <em>does not</em> concern any other model in the final composition. The base class is named <code>IsotropicHardening</code> following the naming convention. The header file <a class="el" href="classneml2_1_1IsotropicHardening.html">IsotropicHardening.h</a> is displayed below </p><div class="fragment"><div class="line"><span class="preprocessor">#pragma once</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">class </span>IsotropicHardening : <span class="keyword">public</span> Model</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> OptionSet <a class="code hl_function" href="classneml2_1_1IsotropicHardening.html#acec712ff48d4c0884a1362c116f3257a">expected_options</a>();</div>
<div class="line"> </div>
<div class="line">  IsotropicHardening(<span class="keyword">const</span> OptionSet &amp; <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a> equivalent_plastic_strain;</div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a> isotropic_hardening;</div>
<div class="line">};</div>
<div class="line">} <span class="comment">// namespace neml2</span></div>
<div class="ttc" id="aclassneml2_1_1IsotropicHardening_html_acec712ff48d4c0884a1362c116f3257a"><div class="ttname"><a href="classneml2_1_1IsotropicHardening.html#acec712ff48d4c0884a1362c116f3257a">neml2::IsotropicHardening::expected_options</a></div><div class="ttdeci">static OptionSet expected_options()</div><div class="ttdef"><b>Definition</b> IsotropicHardening.cxx:30</div></div>
<div class="ttc" id="aclassneml2_1_1Model_html_a761d77eb7c81c3e93b34bfe6caf4b132"><div class="ttname"><a href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">neml2::Model::options</a></div><div class="ttdeci">const torch::TensorOptions &amp; options() const</div><div class="ttdoc">This model's tensor options.</div><div class="ttdef"><b>Definition</b> Model.h:116</div></div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> CrossRef.cxx:32</div></div>
<div class="ttc" id="anamespaceneml2_html_a9e1488821b46ffc106c90ab80036b7aa"><div class="ttname"><a href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">neml2::VariableName</a></div><div class="ttdeci">LabeledAxisAccessor VariableName</div><div class="ttdef"><b>Definition</b> Variable.h:35</div></div>
</div><!-- fragment --><p> Since isotropic hardening <em>is a</em> model, the class inherits from <code>Model</code>. The user-facing expected parameters are defined by the static method <code>expected_options</code>. NEML2 handles the parsing of user parameters and pass them to the constructor. The input variable of the model is the equivalent plastic strain, and the output variable of the model is the isotropic hardening. Their corresponding variable accessors are stored as public member variables <code>equivalent_plastic_strain</code> and <code>isotropic_hardening</code>, respectively.</p>
<p>The expected parameters and the constructor are defined as </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/solid_mechanics/IsotropicHardening.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line">OptionSet</div>
<div class="line"><a class="code hl_function" href="classneml2_1_1IsotropicHardening.html#acec712ff48d4c0884a1362c116f3257a">IsotropicHardening::expected_options</a>()</div>
<div class="line">{</div>
<div class="line">  OptionSet <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a> = <a class="code hl_function" href="classneml2_1_1Model.html#acec712ff48d4c0884a1362c116f3257a">Model::expected_options</a>();</div>
<div class="line">  <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a>.set&lt;<a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>&gt;(<span class="stringliteral">&quot;equivalent_plastic_strain&quot;</span>) = {{<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;internal&quot;</span>, <span class="stringliteral">&quot;ep&quot;</span>}};</div>
<div class="line">  <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a>.set&lt;<a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>&gt;(<span class="stringliteral">&quot;isotropic_hardening&quot;</span>) = {{<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;internal&quot;</span>, <span class="stringliteral">&quot;k&quot;</span>}};</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="classneml2_1_1IsotropicHardening.html#aa1a9bb4383495d684fe4c362ebcfe33e">IsotropicHardening::IsotropicHardening</a>(<span class="keyword">const</span> OptionSet &amp; options)</div>
<div class="line">  : Model(options),</div>
<div class="line">    equivalent_plastic_strain(declare_input_variable&lt;Scalar&gt;(</div>
<div class="line">        options.get&lt;<a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>&gt;(<span class="stringliteral">&quot;equivalent_plastic_strain&quot;</span>))),</div>
<div class="line">    isotropic_hardening(</div>
<div class="line">        declare_output_variable&lt;Scalar&gt;(options.get&lt;<a class="code hl_typedef" href="namespaceneml2.html#a9e1488821b46ffc106c90ab80036b7aa">VariableName</a>&gt;(<span class="stringliteral">&quot;isotropic_hardening&quot;</span>)))</div>
<div class="line">{</div>
<div class="line">  setup();</div>
<div class="line">}</div>
<div class="line">} <span class="comment">// namespace neml2</span></div>
<div class="ttc" id="aclassneml2_1_1IsotropicHardening_html_aa1a9bb4383495d684fe4c362ebcfe33e"><div class="ttname"><a href="classneml2_1_1IsotropicHardening.html#aa1a9bb4383495d684fe4c362ebcfe33e">neml2::IsotropicHardening::IsotropicHardening</a></div><div class="ttdeci">IsotropicHardening(const OptionSet &amp;options)</div><div class="ttdef"><b>Definition</b> IsotropicHardening.cxx:38</div></div>
<div class="ttc" id="aclassneml2_1_1Model_html_acec712ff48d4c0884a1362c116f3257a"><div class="ttname"><a href="classneml2_1_1Model.html#acec712ff48d4c0884a1362c116f3257a">neml2::Model::expected_options</a></div><div class="ttdeci">static OptionSet expected_options()</div><div class="ttdef"><b>Definition</b> Model.cxx:32</div></div>
</div><!-- fragment --><p> Both the equivalent plastic strain and the isotropic hardening are internal state, denoted as "state/internal/ep" and "state/internal/k", respectively. The <code>IsotropicHardening</code> is constructed by extracting user-specified parameters. Note how <code>declare_input_variable&lt;Scalar&gt;</code> and <code>declare_output_variable&lt;Scalar&gt;</code> are used to declare and register the input and output variables.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Tutorial 2: Parameter declaration and registraion</h1>
<p>Now that the abstract base class <code>IsotropicHardening</code> has been implemented, we are ready to define our first concrete NEML2 model that describes a linear isotropic hardening relation  </p><p class="formulaDsp">
\[
  k = H \bar{\varepsilon}^p.
\]
</p>
<p> Note that \(H\) is a model parameter. Following the naming convention, the concrete class is named <code>LinearIsotropicHardening</code>. The header file is displayed below. </p><div class="fragment"><div class="line"><span class="preprocessor">#pragma once</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;neml2/models/solid_mechanics/IsotropicHardening.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">class </span>LinearIsotropicHardening : <span class="keyword">public</span> IsotropicHardening</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> OptionSet <a class="code hl_function" href="classneml2_1_1LinearIsotropicHardening.html#acec712ff48d4c0884a1362c116f3257a">expected_options</a>();</div>
<div class="line"> </div>
<div class="line">  LinearIsotropicHardening(<span class="keyword">const</span> OptionSet &amp; <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code hl_function" href="classneml2_1_1LinearIsotropicHardening.html#af5600a36813e455aefee72bec1d574fb">set_value</a>(<span class="keyword">const</span> LabeledVector &amp; in,</div>
<div class="line">                         LabeledVector * out,</div>
<div class="line">                         LabeledMatrix * dout_din = <span class="keyword">nullptr</span>,</div>
<div class="line">                         LabeledTensor3D * d2out_din2 = <span class="keyword">nullptr</span>) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  Scalar <a class="code hl_variable" href="classneml2_1_1LinearIsotropicHardening.html#aa0dde0f9a60dafc1c8b755d657499c7d">_K</a>;</div>
<div class="line">};</div>
<div class="line">} <span class="comment">// namespace neml2</span></div>
<div class="ttc" id="aclassneml2_1_1LinearIsotropicHardening_html_aa0dde0f9a60dafc1c8b755d657499c7d"><div class="ttname"><a href="classneml2_1_1LinearIsotropicHardening.html#aa0dde0f9a60dafc1c8b755d657499c7d">neml2::LinearIsotropicHardening::_K</a></div><div class="ttdeci">const Scalar &amp; _K</div><div class="ttdef"><b>Definition</b> LinearIsotropicHardening.h:45</div></div>
<div class="ttc" id="aclassneml2_1_1LinearIsotropicHardening_html_acec712ff48d4c0884a1362c116f3257a"><div class="ttname"><a href="classneml2_1_1LinearIsotropicHardening.html#acec712ff48d4c0884a1362c116f3257a">neml2::LinearIsotropicHardening::expected_options</a></div><div class="ttdeci">static OptionSet expected_options()</div><div class="ttdef"><b>Definition</b> LinearIsotropicHardening.cxx:32</div></div>
<div class="ttc" id="aclassneml2_1_1LinearIsotropicHardening_html_af5600a36813e455aefee72bec1d574fb"><div class="ttname"><a href="classneml2_1_1LinearIsotropicHardening.html#af5600a36813e455aefee72bec1d574fb">neml2::LinearIsotropicHardening::set_value</a></div><div class="ttdeci">void set_value(bool out, bool dout_din, bool d2out_din2) override</div><div class="ttdoc">The map between input -&gt; output, and optionally its derivatives.</div><div class="ttdef"><b>Definition</b> LinearIsotropicHardening.cxx:46</div></div>
</div><!-- fragment --><p> It derives from the abstract base class <code>IsotropicHardening</code> and implements the virtual method <code>set_value</code> as the forward operator. The model parameter \(H\) is stored as a protected member variable <code>_K</code>. The model implementation is shown below. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/models/solid_mechanics/LinearIsotropicHardening.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a></div>
<div class="line">{</div>
<div class="line">register_NEML2_object(LinearIsotropicHardening);</div>
<div class="line"> </div>
<div class="line">OptionSet</div>
<div class="line"><a class="code hl_function" href="classneml2_1_1LinearIsotropicHardening.html#acec712ff48d4c0884a1362c116f3257a">LinearIsotropicHardening::expected_options</a>()</div>
<div class="line">{</div>
<div class="line">  OptionSet <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a> = <a class="code hl_function" href="classneml2_1_1IsotropicHardening.html#acec712ff48d4c0884a1362c116f3257a">IsotropicHardening::expected_options</a>();</div>
<div class="line">  <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a>.set&lt;CrossRef&lt;Scalar&gt;&gt;(<span class="stringliteral">&quot;hardening_modulus&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_function" href="classneml2_1_1Model.html#a761d77eb7c81c3e93b34bfe6caf4b132">options</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="classneml2_1_1LinearIsotropicHardening.html#aaaaad6f26335889463eda2389411ea0f">LinearIsotropicHardening::LinearIsotropicHardening</a>(<span class="keyword">const</span> OptionSet &amp; options)</div>
<div class="line">  : IsotropicHardening(options),</div>
<div class="line">    _K(declare_parameter&lt;Scalar&gt;(<span class="stringliteral">&quot;K&quot;</span>, <span class="stringliteral">&quot;hardening_modulus&quot;</span>))</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">LinearIsotropicHardening::set_value(<span class="keyword">const</span> LabeledVector &amp; in,</div>
<div class="line">                                    LabeledVector * out,</div>
<div class="line">                                    LabeledMatrix * dout_din,</div>
<div class="line">                                    LabeledTensor3D * d2out_din2)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (out)</div>
<div class="line">    out-&gt;set(_K * in(equivalent_plastic_strain), isotropic_hardening);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (dout_din)</div>
<div class="line">    dout_din-&gt;set(_K, isotropic_hardening, equivalent_plastic_strain);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (d2out_din2)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// zero</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line">} <span class="comment">// namespace neml2</span></div>
<div class="ttc" id="aclassneml2_1_1LinearIsotropicHardening_html_aaaaad6f26335889463eda2389411ea0f"><div class="ttname"><a href="classneml2_1_1LinearIsotropicHardening.html#aaaaad6f26335889463eda2389411ea0f">neml2::LinearIsotropicHardening::LinearIsotropicHardening</a></div><div class="ttdeci">LinearIsotropicHardening(const OptionSet &amp;options)</div><div class="ttdef"><b>Definition</b> LinearIsotropicHardening.cxx:39</div></div>
</div><!-- fragment --><p> Note that an additional option named "hardening_modulus" is requested from the user. The model parameter is registered using the API <code>declare_parameter&lt;Scalar&gt;</code>. In the <code>set_value</code> method, the current value of the input variable equivalent plastic strain is queried by </p><div class="fragment"><div class="line">in(equivalent_plastic_strain)</div>
</div><!-- fragment --><p> and the isotropic hardening is computed as </p><div class="fragment"><div class="line">_K * in(equivalent_plastic_strain)</div>
</div><!-- fragment --><p> The computed result is copied into the model output <code>out</code> by </p><div class="fragment"><div class="line">out-&gt;set(_K * in(equivalent_plastic_strain), isotropic_hardening);</div>
</div><!-- fragment --><p> In addition, the first derivative of the forward operator is defined as </p><div class="fragment"><div class="line">dout_din-&gt;set(_K, isotropic_hardening, equivalent_plastic_strain);</div>
</div><!-- fragment --><p> Finally, the model is registed in the NEML2 model factory using the macro </p><div class="fragment"><div class="line">register_NEML2_object(LinearIsotropicHardening);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
Tutorial 3: Testing</h1>
<p>It is of paramount importance to ensure the correctness of the implementation. NEML2 offers 5 types of tests with different purposes:</p>
<h2>Catch2 test</h2>
<p>A Catch2 test refers to a test directly written in C++ source code within the Catch2 framework. It offers the highest level of flexibility, but requires more effort to set up. To understand how a Catch2 test works, please refer to the <a href="https://github.com/catchorg/Catch2/blob/v2.x/docs/tutorial.md">official Catch2 documentation</a>.</p>
<h2>Model unit test</h2>
<p>A model unit test examines the outputs of a <code>Model</code> given a predefined set of inputs. Model unit tests can be directly designed using the input file syntax with the <code>ModelUnitTest</code> type. A variety of checks can be turned on and off. To list a few: <code>check_first_derivatives</code> compares the implemented first order derivatives of the model against finite-differencing results, and passes only if the two derivatives are within tolerances specified with <code>derivative_abs_tol</code> and <code>derivative_rel_tol</code>; <code>check_cuda</code> repeats all checks twice: once on CPU and once on GPU (if available), and passes only if the two evaluations yield same results within tolerances.</p>
<p>All input files for model unit tests should be stored inside <code>tests/unit/models</code>. Every input file with the <code>.i</code> extension will be automatically discovered and executed. To run all the model unit tests, use the following commands </p><div class="fragment"><div class="line">cd tests</div>
<div class="line">./unit_tests models</div>
</div><!-- fragment --><p>To run a specific model unit test, use the <code>-c</code> command line option followed by the relative location of the input file, i.e. </p><div class="fragment"><div class="line">cd tests</div>
<div class="line">./unit_tests models -c solid_mechanics/LinearIsotropicElasticity.i</div>
</div><!-- fragment --><h2>Model regression test</h2>
<p>A model regression test runs a <code>Model</code> using a user specified driver. The results are compared against a predefined reference (stored on the disk inside the repository). The test passes only if the current results are the same as the predefined reference (again within specified tolerances). The regression tests ensure the consistency of implementations across commits. Currently, <code>TransientRegression</code> is the only supported type of regression test.</p>
<p>Each input file for model regression tests should be stored inside a separate folder inside <code>tests/regression</code>. Every input file with the <code>.i</code> extension will be automatically discovered and executed. To run all the model regression tests, use the <code>regression_tests</code> executable followed by the physics module, i.e. </p><div class="fragment"><div class="line">cd tests</div>
<div class="line">./regression_tests &quot;solid mechanics&quot;</div>
</div><!-- fragment --><p> To run a specific model regression test, use the <code>-c</code> command line option followed by the relative location of the input file, i.e. </p><div class="fragment"><div class="line">cd tests</div>
<div class="line">./regression_tests &quot;solid mechanics&quot; -c viscoplasticity/chaboche/model.i</div>
</div><!-- fragment --><p> Note that the regression test expectes a option <code>reference</code> which specifies the relative location to the reference solution.</p>
<h2>Model verification test</h2>
<p>The model verification test is similar to the model regression test in terms of workflow. The difference is the a verification test defines the reference solution using NEML, the predecessor of NEML2. Since NEML was developed with strict software assurance, the verification tests ensure that the migration from NEML to NEML2 is as smooth as it can be.</p>
<p>Each input file for model verification tests should be stored inside a separate folder inside <code>tests/verification</code>. Every input file with the <code>.i</code> extension will be automatically discovered and executed. To run all the model verification tests, use the <code>verification_tests</code> executable followed by the physics module, i.e. </p><div class="fragment"><div class="line">cd tests</div>
<div class="line">./verification_tests &quot;solid mechanics&quot;</div>
</div><!-- fragment --><p>To run a specific model verification test, use the <code>-c</code> command line option followed by the relative location of the input file, i.e. </p><div class="fragment"><div class="line">cd tests</div>
<div class="line">./verification_tests &quot;solid mechanics&quot; -c chaboche/chaboche.i</div>
</div><!-- fragment --><p> The regression test compares variables (specified using the <code>variables</code> option) against reference values (specified using the <code>references</code> option). The reference variables can be read using input objects with type <code>VTestTimeSeries</code>.</p>
<h2>Benchmarking</h2>
<p>The benchmark tests can be authored within the <a href="https://github.com/catchorg/Catch2/blob/v2.x/docs/benchmarks.md">Catch2 microbenchmarking framework</a>. Before any benchmarks can be executed, the clock's resolution is estimated. A few other environmental artifacts are also estimated at this point, like the cost of calling the clock function, but they almost never have any impact in the results. The user code is executed a few times to obtain an estimate of the amount of runs that should be in each sample. This also has the potential effect of bringing relevant code and data into the caches before the actual measurement starts. Finally, all the samples are collected sequentially by performing the number of runs estimated in the previous step for each sample.</p>
<p>To run a benchmark test, use the <code>benchmark.sh</code> script inside the <code>scripts</code> directory with 3 positional arguments: </p><div class="fragment"><div class="line">./scripts/benchmark.sh Chaboche 5 timings</div>
</div><!-- fragment --><p> The first positional argument specifies the name of the benchmark test to run. The second positional argument specifies the number of samples to repeat in each iteration. The third positional argument specifies the output directory of the benchmark results.</p>
<p>The Chaboche benchmark test is repeated with different batch sizes and on different devices (in this case CPU and GPU). The final benchmark results are summarized in the following figure.</p>
<div class="image">
<img src="timings.png" alt="" width="50%"/>
<div class="caption">
Chaboche benchmark results</div></div>
     </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
