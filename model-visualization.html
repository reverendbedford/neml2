<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NEML2: Model visualization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams','[tex]/physics','[tex]/boldsymbol']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams','physics','boldsymbol']
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NEML2<span id="projectnumber">&#160;2.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('model-visualization.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Model visualization</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2neml2_2neml2_2doc_2content_2dev_2graph"></a> During the process of model development, it is of general interest (and is also very much encouraged) to reuse existing models. This is particularly useful and effective owing to the extreme modular design of NEML2, i.e., model composition.</p>
<p>However, from times to times, the composed model may become overwhelmingly complicated even for an experienced developer. For example, given a single-crystal crystal plasticity model with decoupled time integration defined in an input file <code>input.i</code> with the following content </p><div class="fragment"><div class="line">[Tensors]</div>
<div class="line">  [a]</div>
<div class="line">    type = Scalar</div>
<div class="line">    values = <span class="stringliteral">&#39;1.0&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [sdirs]</div>
<div class="line">    type = FillMillerIndex</div>
<div class="line">    values = <span class="stringliteral">&#39;1 1 0&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [splanes]</div>
<div class="line">    type = FillMillerIndex</div>
<div class="line">    values = <span class="stringliteral">&#39;1 1 1&#39;</span></div>
<div class="line">  []</div>
<div class="line">[]</div>
<div class="line"> </div>
<div class="line">[Solvers]</div>
<div class="line">  [newton]</div>
<div class="line">    type = NewtonWithLineSearch</div>
<div class="line">    max_linesearch_iterations = 5</div>
<div class="line">  []</div>
<div class="line">[]</div>
<div class="line"> </div>
<div class="line">[Data]</div>
<div class="line">  [crystal_geometry]</div>
<div class="line">    type = CubicCrystal</div>
<div class="line">    lattice_parameter = <span class="stringliteral">&#39;a&#39;</span></div>
<div class="line">    slip_directions = <span class="stringliteral">&#39;sdirs&#39;</span></div>
<div class="line">    slip_planes = <span class="stringliteral">&#39;splanes&#39;</span></div>
<div class="line">  []</div>
<div class="line">[]</div>
<div class="line"> </div>
<div class="line">[Models]</div>
<div class="line">  [euler_rodrigues_1]</div>
<div class="line">    type = RotationMatrix</div>
<div class="line">    <span class="keyword">from</span> = <span class="stringliteral">&#39;forces/tmp/orientation&#39;</span></div>
<div class="line">    to = <span class="stringliteral">&#39;state/orientation_matrix&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [elasticity_1]</div>
<div class="line">    type = LinearIsotropicElasticity</div>
<div class="line">    youngs_modulus = 1e5</div>
<div class="line">    poisson_ratio = 0.25</div>
<div class="line">    strain = <span class="stringliteral">&#39;state/elastic_strain&#39;</span></div>
<div class="line">    stress = <span class="stringliteral">&#39;state/internal/cauchy_stress&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [resolved_shear]</div>
<div class="line">    type = ResolvedShear</div>
<div class="line">  []</div>
<div class="line">  [elastic_stretch]</div>
<div class="line">    type = ElasticStrainRate</div>
<div class="line">  []</div>
<div class="line">  [plastic_deformation_rate]</div>
<div class="line">    type = PlasticDeformationRate</div>
<div class="line">  []</div>
<div class="line">  [sum_slip_rates]</div>
<div class="line">    type = SumSlipRates</div>
<div class="line">  []</div>
<div class="line">  [slip_rule]</div>
<div class="line">    type = PowerLawSlipRule</div>
<div class="line">    n = 8.0</div>
<div class="line">    gamma0 = 2.0e-1</div>
<div class="line">  []</div>
<div class="line">  [slip_strength]</div>
<div class="line">    type = SingleSlipStrengthMap</div>
<div class="line">    constant_strength = 50.0</div>
<div class="line">  []</div>
<div class="line">  [voce_hardening]</div>
<div class="line">    type = VoceSingleSlipHardeningRule</div>
<div class="line">    initial_slope = 500.0</div>
<div class="line">    saturated_hardening = 50.0</div>
<div class="line">  []</div>
<div class="line">  [integrate_slip_hardening]</div>
<div class="line">    type = ScalarBackwardEulerTimeIntegration</div>
<div class="line">    variable = <span class="stringliteral">&#39;state/internal/slip_hardening&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [integrate_elastic_strain]</div>
<div class="line">    type = SR2BackwardEulerTimeIntegration</div>
<div class="line">    variable = <span class="stringliteral">&#39;state/elastic_strain&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [implicit_rate_1]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = <span class="stringliteral">&quot;euler_rodrigues_1 elasticity_1 resolved_shear</span></div>
<div class="line"><span class="stringliteral">              elastic_stretch plastic_deformation_rate</span></div>
<div class="line"><span class="stringliteral">              sum_slip_rates slip_rule slip_strength voce_hardening</span></div>
<div class="line"><span class="stringliteral">              integrate_slip_hardening integrate_elastic_strain&quot;</span></div>
<div class="line"><span class="stringliteral">  []</span></div>
<div class="line"><span class="stringliteral">  [subsystem1]</span></div>
<div class="line"><span class="stringliteral">    type = ImplicitUpdate</span></div>
<div class="line"><span class="stringliteral">    implicit_model = &#39;implicit_rate_1&#39;</span></div>
<div class="line">    solver = <span class="stringliteral">&#39;newton&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [euler_rodrigues_2]</div>
<div class="line">    type = RotationMatrix</div>
<div class="line">    <span class="keyword">from</span> = <span class="stringliteral">&#39;state/orientation&#39;</span></div>
<div class="line">    to = <span class="stringliteral">&#39;state/orientation_matrix&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [elasticity_2]</div>
<div class="line">    type = LinearIsotropicElasticity</div>
<div class="line">    youngs_modulus = 1e5</div>
<div class="line">    poisson_ratio = 0.25</div>
<div class="line">    strain = <span class="stringliteral">&#39;forces/tmp/elastic_strain&#39;</span></div>
<div class="line">    stress = <span class="stringliteral">&#39;state/internal/cauchy_stress&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [orientation_rate]</div>
<div class="line">    type = OrientationRate</div>
<div class="line">    elastic_strain = <span class="stringliteral">&#39;forces/tmp/elastic_strain&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [plastic_spin]</div>
<div class="line">    type = PlasticVorticity</div>
<div class="line">  []</div>
<div class="line">  [slip_strength_2]</div>
<div class="line">    type = SingleSlipStrengthMap</div>
<div class="line">    constant_strength = 50.0</div>
<div class="line">    slip_hardening = <span class="stringliteral">&#39;forces/tmp/internal/slip_hardening&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [integrate_orientation]</div>
<div class="line">    type = WR2ImplicitExponentialTimeIntegration</div>
<div class="line">    variable = <span class="stringliteral">&#39;state/orientation&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [implicit_rate_2]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = <span class="stringliteral">&quot;euler_rodrigues_2 elasticity_2 resolved_shear</span></div>
<div class="line"><span class="stringliteral">              plastic_deformation_rate plastic_spin</span></div>
<div class="line"><span class="stringliteral">              slip_rule slip_strength_2 orientation_rate</span></div>
<div class="line"><span class="stringliteral">              integrate_orientation&quot;</span></div>
<div class="line"><span class="stringliteral">  []</span></div>
<div class="line"><span class="stringliteral">  [subsystem2]</span></div>
<div class="line"><span class="stringliteral">    type = ImplicitUpdate</span></div>
<div class="line"><span class="stringliteral">    implicit_model = &#39;implicit_rate_2&#39;</span></div>
<div class="line">    solver = <span class="stringliteral">&#39;newton&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [cache_elastic_strain]</div>
<div class="line">    type = CopySR2</div>
<div class="line">    <span class="keyword">from</span> = <span class="stringliteral">&#39;state/elastic_strain&#39;</span></div>
<div class="line">    to = <span class="stringliteral">&#39;forces/tmp/elastic_strain&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [cache_slip_hardening]</div>
<div class="line">    type = CopyScalar</div>
<div class="line">    <span class="keyword">from</span> = <span class="stringliteral">&#39;state/internal/slip_hardening&#39;</span></div>
<div class="line">    to = <span class="stringliteral">&#39;forces/tmp/internal/slip_hardening&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [cache1]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = <span class="stringliteral">&#39;cache_elastic_strain cache_slip_hardening&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [cache2]</div>
<div class="line">    type = CopyWR2</div>
<div class="line">    <span class="keyword">from</span> = <span class="stringliteral">&#39;state/orientation&#39;</span></div>
<div class="line">    to = <span class="stringliteral">&#39;forces/tmp/orientation&#39;</span></div>
<div class="line">  []</div>
<div class="line">  [model]</div>
<div class="line">    type = ComposedModel</div>
<div class="line">    models = <span class="stringliteral">&#39;cache2 subsystem1 cache1 subsystem2&#39;</span></div>
<div class="line">    priority = <span class="stringliteral">&#39;cache2 subsystem1 cache1 subsystem2&#39;</span></div>
<div class="line">    additional_outputs = <span class="stringliteral">&#39;state/elastic_strain state/internal/slip_hardening&#39;</span></div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p> It is undoubtedly difficult to understanding the model composition just by reading the input file. To address such challenge, the <code>visualization</code> module is provided as part of the NEML2 Python package to help extract, plot, and customize the dependency graph of a composed model. The generated dependency graph provides a visual understanding of the model composition, helps identify otherwise-difficult-to-find issues, and opens up opportunities for optimizing of the composition.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Rendering non-composed model</h1>
<p>NEML2 relies on the Python interface of <a href="https://graphviz.readthedocs.io/en/stable/index.html">Graphviz</a> to render the dependency graph. To visualize a basic non-composed model, simply load the model from the input file and pass it to the <code>neml2.visualization.render</code> function. </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> <a class="code hl_class" href="classneml2_1_1CrossRef.html">neml2.visualization</a> <span class="keyword">import</span> render</div>
<div class="line"> </div>
<div class="line">model = <a class="code hl_function" href="namespaceneml2.html#a0e8c7aeae6d7c24a44a404965d5b5fa3">neml2.load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;euler_rodrigues_1&quot;</span>)</div>
<div class="line">render(model, outfile=<span class="stringliteral">&quot;graph.svg&quot;</span>)</div>
<div class="ttc" id="aclassneml2_1_1CrossRef_html"><div class="ttname"><a href="classneml2_1_1CrossRef.html">neml2::CrossRef</a></div><div class="ttdoc">The wrapper (decorator) for cross-referencing unresolved values at parse time.</div><div class="ttdef"><b>Definition</b> CrossRef.h:56</div></div>
<div class="ttc" id="anamespaceneml2_html_a0e8c7aeae6d7c24a44a404965d5b5fa3"><div class="ttname"><a href="namespaceneml2.html#a0e8c7aeae6d7c24a44a404965d5b5fa3">neml2::load_model</a></div><div class="ttdeci">Model &amp; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname, bool enable_ad)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> Factory.cxx:69</div></div>
</div><!-- fragment --><p> The <code>render</code> function calls <a href="https://graphviz.readthedocs.io/en/stable/api.html#graphviz.render"><code>graphviz.render</code></a> behind the scenes, and additional arguments and keyword arguments are forwarded without modification. By default, an intermediate graphviz source file (written in the DOT language) with suffix <code>.gz</code> and the rendered output specified by <code>outfile</code> are generated. Customization of the graph will be discussed later. NEML2 provides some sensible default settings which generates the graph below.</p>
<div class="image">
<object type="image/svg+xml" data="graph_basic.svg" width="25%" style="pointer-events: none;"></object>
<div class="caption">
Graph of a basic model</div></div>
    <p>There are three components in the above image:</p><ul>
<li>The input variable represented as a gray rectangular node</li>
<li>The model represented as a blue rectangular node</li>
<li>The output variable represented as a green rectangular node</li>
</ul>
<p>Additional information are also labeled on each node enclosed within square brackets, such as the variable type (e.g. <code>[Rot]</code>, <code>[R2]</code>) and the model type (e.g. <code>[RotationMatrix]</code>). Note that the rounded dashed border around the variables denote sub-axes, and the sub-axis name is also labeled. Edges (arrows) in this directed graph represent information flow, i.e., the input variable is passed into the model, the model performs a set of operations and produces the output variable.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Rendering composed model</h1>
<p>The dependency graph of a composed model can also be visualized using a similar routine, </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> <a class="code hl_class" href="classneml2_1_1CrossRef.html">neml2.visualization</a> <span class="keyword">import</span> render</div>
<div class="line"> </div>
<div class="line">model = <a class="code hl_function" href="namespaceneml2.html#a0e8c7aeae6d7c24a44a404965d5b5fa3">neml2.load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;implicit_rate_1&quot;</span>)</div>
<div class="line">render(model, outfile=<span class="stringliteral">&quot;graph.svg&quot;</span>)</div>
</div><!-- fragment --><p> Note the model name is changed to "implicit_rate_1" which is a composed model. The generated graph is shown below.</p>
<div class="image">
<object type="image/svg+xml" data="graph_composed.svg" width="85%" style="pointer-events: none;"></object>
<div class="caption">
Graph of a composed model</div></div>
    <p>Each shaded area represents a sub-model in the composed model. When graph constraints allow, the input variables of the composed model are shown at the very top, and the output variables of the composed model are shown at the very bottom.</p>
<dl class="section note"><dt>Note</dt><dd>The svg and pdf output formats allow arbitrary zooming without loss of resolution.</dd></dl>
<p>For Visual Studio Code users, the <a href="https://marketplace.visualstudio.com/items?itemName=tintinweb.graphviz-interactive-preview">Graphviz Interactive Preview</a> extension can be used to directly preview the graphviz source code. The extension supports useful postprocessing operations such as node highlighting and filtering. For example, the following screenshot demonstrates upstream highlight of an intermediate output variable <code>state/internal/sum_slip_rates</code>.</p>
<div class="image">
<object type="image/svg+xml" data="graph_highlight.svg" width="85%" style="pointer-events: none;"></object>
<div class="caption">
Graph of a composed model with upstream highlighting</div></div>
    <h1><a class="anchor" id="autotoc_md7"></a>
Customizing graph style</h1>
<p>The generated graph is highly customizable. All controllable attributes are available in the data class <code>Configuration</code>. The configuration can be modified with an instance of the data class, i.e. </p><div class="fragment"><div class="line"><span class="keyword">import</span> neml2</div>
<div class="line"><span class="keyword">from</span> <a class="code hl_class" href="classneml2_1_1CrossRef.html">neml2.visualization</a> <span class="keyword">import</span> render, Configuration</div>
<div class="line"> </div>
<div class="line">model = <a class="code hl_function" href="namespaceneml2.html#a0e8c7aeae6d7c24a44a404965d5b5fa3">neml2.load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;implicit_rate_1&quot;</span>)</div>
<div class="line"> </div>
<div class="line">config = Configuration()</div>
<div class="line">config.global_attributes[<span class="stringliteral">&quot;fontname&quot;</span>] = <span class="stringliteral">&quot;Times-Roman&quot;</span></div>
<div class="line">config.global_node_attributes[<span class="stringliteral">&quot;fontname&quot;</span>] = <span class="stringliteral">&quot;Arial&quot;</span></div>
<div class="line">config.global_edge_attributes[<span class="stringliteral">&quot;arrowhead&quot;</span>] = <span class="stringliteral">&quot;empty&quot;</span></div>
<div class="line">config.submodel_name_node_attributes[<span class="stringliteral">&quot;color&quot;</span>] = <span class="stringliteral">&quot;#bf0036&quot;</span></div>
<div class="line">config.submodel_name_node_attributes[<span class="stringliteral">&quot;fillcolor&quot;</span>] = <span class="stringliteral">&quot;#bf003650&quot;</span></div>
<div class="line">config.input_node_attributes[<span class="stringliteral">&quot;color&quot;</span>] = <span class="stringliteral">&quot;#00540150&quot;</span></div>
<div class="line">config.input_node_attributes[<span class="stringliteral">&quot;fillcolor&quot;</span>] = <span class="stringliteral">&quot;#00540115&quot;</span></div>
<div class="line">config.output_node_attributes[<span class="stringliteral">&quot;color&quot;</span>] = <span class="stringliteral">&quot;#8800ff50&quot;</span></div>
<div class="line">config.output_node_attributes[<span class="stringliteral">&quot;fillcolor&quot;</span>] = <span class="stringliteral">&quot;#8800ff15&quot;</span></div>
<div class="line"> </div>
<div class="line">render(model, outfile=<span class="stringliteral">&quot;graph.svg&quot;</span>)</div>
</div><!-- fragment --><p> The font names, arrow head style, and node fill colors are modified from their default values. The generated graph is shown below.</p>
<div class="image">
<object type="image/svg+xml" data="graph_custom.svg" width="85%" style="pointer-events: none;"></object>
<div class="caption">
Graph of a composed model with custom style</div></div>
     </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
