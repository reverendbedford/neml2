<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NEML2: C++ Backend</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams','[tex]/physics','[tex]/boldsymbol']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams','physics','boldsymbol']
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NEML2<span id="projectnumber">&#160;2.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('cpp-backend.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">C++ Backend</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md44">Loading a model from an input file</a></li>
<li class="level1"><a href="#autotoc_md45">Inspecting model information</a></li>
<li class="level1"><a href="#autotoc_md46">Evaluate the model</a></li>
<li class="level1"><a href="#autotoc_md47">Model parameters</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2neml2_2neml2_2doc_2content_2user_2cpp"></a></p>
<h1><a class="anchor" id="autotoc_md44"></a>
Loading a model from an input file</h1>
<p>The following input file defines a linear isotropic elasticity material model:</p>
<div class="fragment"><div class="line">[Models]</div>
<div class="line">  [model]</div>
<div class="line">    type = LinearIsotropicElasticity</div>
<div class="line">    youngs_modulus = 100</div>
<div class="line">    poisson_ratio = 0.3</div>
<div class="line">    strain = <span class="stringliteral">&#39;forces/E&#39;</span></div>
<div class="line">    stress = <span class="stringliteral">&#39;state/S&#39;</span></div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p>The input file defines two parameters: Young's modulus of 100 and Poisson's ratio of 0.3. While optional, the input file also sets the variable names of strain and stress to be "forces/E" and "state/S", respectively (refer to the documentation on tensor labeling for variable naming conventions).</p>
<p>Assuming the above input file is named "input_file.i", the C++ code snippet below parses the input file and loads the material model (into the heap).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/base/Factory.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/tensors.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/misc/math.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">  <span class="keyword">auto</span> &amp; model = <a class="code hl_function" href="namespaceneml2.html#a1e499dee97d6a66663f60dd4a65b9f1a">neml2::load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;model&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceneml2_html_a1e499dee97d6a66663f60dd4a65b9f1a"><div class="ttname"><a href="namespaceneml2.html#a1e499dee97d6a66663f60dd4a65b9f1a">neml2::load_model</a></div><div class="ttdeci">Model &amp; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> Factory.cxx:66</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md45"></a>
Inspecting model information</h1>
<p>Once the model is loaded, it can be streamed to provide a high-level summary of the model, i.e., </p><div class="fragment"><div class="line">std::cout &lt;&lt; model &lt;&lt; std::endl;</div>
</div><!-- fragment --><p> The example model produces the following summary </p><div class="fragment"><div class="line">Name:       model</div>
<div class="line">Dtype:      double</div>
<div class="line">Device:     cpu</div>
<div class="line">Input:      forces/E [SR2]</div>
<div class="line">Output:     state/S [SR2]</div>
<div class="line">Parameters: E [Scalar]</div>
<div class="line">            nu [Scalar]</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md46"></a>
Evaluate the model</h1>
<p>Suppose we want to perform 3 material updates simultaneously, the input variables shall have a batch size of 3 (refer to the <a class="el" href="system-tensors.html">tensor system documentation</a> for more detailed explanation on the term "batch"). The following code constructs the 3 input strains and performs 3 material updates <em>simultaneously</em>.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> strain_name = <a class="code hl_typedef" href="namespaceneml2.html#a5cf0dc3e9d16378ebe48923973730e54">neml2::VariableName</a>(<span class="stringliteral">&quot;forces&quot;</span>, <span class="stringliteral">&quot;E&quot;</span>);</div>
<div class="line"><span class="keyword">auto</span> stress_name = <a class="code hl_typedef" href="namespaceneml2.html#a5cf0dc3e9d16378ebe48923973730e54">neml2::VariableName</a>(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;S&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> strain1 = <a class="code hl_function" href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a>(0.1, 0.2, 0.3, -0.1, -0.1, 0.2);</div>
<div class="line"><span class="keyword">auto</span> strain2 = <a class="code hl_function" href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a>(0.2, 0.2, 0.1, -0.1, -0.2, -0.5);</div>
<div class="line"><span class="keyword">auto</span> strain3 = <a class="code hl_function" href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a>(0.3, -0.2, 0.05, -0.1, -0.3, 0.1);</div>
<div class="line"><span class="keyword">auto</span> strain = <a class="code hl_function" href="namespaceneml2_1_1math.html#a81a590536ba015864bc8aab1e212d402">neml2::math::batch_stack</a>({strain1, strain2, strain3});</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> output = model.value({{strain_name, strain}});</div>
<div class="line"><span class="keyword">auto</span> stress = output.at(stress_name)</div>
<div class="ttc" id="aclassneml2_1_1SR2_html_af267747e919faf52e046ee51b493ce0d"><div class="ttname"><a href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a></div><div class="ttdeci">static SR2 fill(const Real &amp;a, const torch::TensorOptions &amp;options=default_tensor_options())</div><div class="ttdoc">Fill the diagonals with a11 = a22 = a33 = a.</div><div class="ttdef"><b>Definition</b> SR2.cxx:47</div></div>
<div class="ttc" id="anamespaceneml2_1_1math_html_a81a590536ba015864bc8aab1e212d402"><div class="ttname"><a href="namespaceneml2_1_1math.html#a81a590536ba015864bc8aab1e212d402">neml2::math::batch_stack</a></div><div class="ttdeci">T batch_stack(const std::vector&lt; T &gt; &amp;tensors, Size d=0)</div><div class="ttdef"><b>Definition</b> math.h:257</div></div>
<div class="ttc" id="anamespaceneml2_html_a5cf0dc3e9d16378ebe48923973730e54"><div class="ttname"><a href="namespaceneml2.html#a5cf0dc3e9d16378ebe48923973730e54">neml2::VariableName</a></div><div class="ttdeci">LabeledAxisAccessor VariableName</div><div class="ttdef"><b>Definition</b> parser_utils.h:33</div></div>
</div><!-- fragment --><p>The forward operator is invoked using the <a class="el" href="classneml2_1_1Model.html#ac6bb8acedf7c5fd0edc83fd9386083c1" title="Evalute the model.">neml2::Model::value</a> method which takes a map of <a class="el" href="classneml2_1_1Tensor.html">neml2::Tensor</a> with keys being <a class="el" href="namespaceneml2.html#a5cf0dc3e9d16378ebe48923973730e54">neml2::VariableName</a>. Other forward operator APIs are available to additionally calculate the first and second derivatives of the output variables with respect to the input variables. There exist a total of 6 variants of the forward operator:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Method   </th><th class="markdownTableHeadCenter">Output variable values   </th><th class="markdownTableHeadCenter">1st order derivatives   </th><th class="markdownTableHeadCenter">2nd order derivatives    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="classneml2_1_1Model.html#ac6bb8acedf7c5fd0edc83fd9386083c1" title="Evalute the model.">neml2::Model::value</a>   </td><td class="markdownTableBodyCenter">\(\checkmark\)   </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><a class="el" href="classneml2_1_1Model.html#a1fc1517bd0ad889c1387565048b266f0" title="Evalute the derivative.">neml2::Model::dvalue</a>   </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyCenter">\(\checkmark\)   </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="classneml2_1_1Model.html#a5f0cae301bce3ce20f1f07dedfc9de03" title="Evalute the second derivatives.">neml2::Model::d2value</a>   </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyCenter">\(\checkmark\)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><a class="el" href="classneml2_1_1Model.html#ad021b73a0687f1416fb1791729b97e07" title="Evalute the model and compute its derivative.">neml2::Model::value_and_dvalue</a>   </td><td class="markdownTableBodyCenter">\(\checkmark\)   </td><td class="markdownTableBodyCenter">\(\checkmark\)   </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="classneml2_1_1Model.html#a31e5e1caf5dabf3ef9b0acde583ae5c6" title="Evalute the first and second derivatives.">neml2::Model::dvalue_and_d2value</a>   </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyCenter">\(\checkmark\)   </td><td class="markdownTableBodyCenter">\(\checkmark\)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><a class="el" href="classneml2_1_1Model.html#a326e09c3f398872d1bfec46b02377111" title="Evalute the model and compute its first and second derivatives.">neml2::Model::value_and_dvalue_and_d2value</a>   </td><td class="markdownTableBodyCenter">\(\checkmark\)   </td><td class="markdownTableBodyCenter">\(\checkmark\)   </td><td class="markdownTableBodyCenter">\(\checkmark\)   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md47"></a>
Model parameters</h1>
<p>Each model contains zero or more parameters. The parameters are initialized with values specified in the input file. In the above example, the elasticity model contains two parameters: <code>E</code> and <code>nu</code>. Model parameters can be retrieved using the <a class="el" href="classneml2_1_1ParameterStore.html#a8c1f0318b14b2c89f483e10161c3c10c" title="Get a writable reference of a parameter.">neml2::Model::get_parameter</a> method, the parameter value can be updated using the assignment operator, and automatic differentiation can be used to track the derivatives w.r.t. a parameter: </p><div class="fragment"><div class="line"><span class="keyword">auto</span> &amp; E = model.get_parameter(<span class="stringliteral">&quot;E&quot;</span>);</div>
<div class="line">E = <a class="code hl_function" href="classneml2_1_1PrimitiveTensor.html#a02437fba177741bfc48dc160c8c28676">neml2::Scalar::full</a>(200.0);</div>
<div class="line">E.requires_grad_();</div>
<div class="ttc" id="aclassneml2_1_1PrimitiveTensor_html_a02437fba177741bfc48dc160c8c28676"><div class="ttname"><a href="classneml2_1_1PrimitiveTensor.html#a02437fba177741bfc48dc160c8c28676">neml2::PrimitiveTensor&lt; Scalar &gt;::full</a></div><div class="ttdeci">static Scalar full(Real init, const torch::TensorOptions &amp;options=default_tensor_options())</div><div class="ttdoc">Unbatched tensor filled with a given value given base shape.</div><div class="ttdef"><b>Definition</b> PrimitiveTensor.h:208</div></div>
</div><!-- fragment --><p> Alternatively, the parameter value can be directly updated using the <a class="el" href="classneml2_1_1ParameterStore.html#a1fdcb02ea1c3d6e1828424ccd400fa36" title="}@">neml2::Model::set_parameter</a> or <a class="el" href="classneml2_1_1ParameterStore.html#a2d96d9f92a985de65651abf452cb49a2" title="Set values for parameters.">neml2::Model::set_parameters</a> method: </p><div class="fragment"><div class="line">model.set_parameter(<span class="stringliteral">&quot;E&quot;</span>, <a class="code hl_function" href="classneml2_1_1PrimitiveTensor.html#a02437fba177741bfc48dc160c8c28676">neml2::Scalar::full</a>(200.0));</div>
</div><!-- fragment --> <div class="fragment"><div class="line">model.set_parameters({{<span class="stringliteral">&quot;E&quot;</span>, <a class="code hl_function" href="classneml2_1_1PrimitiveTensor.html#a02437fba177741bfc48dc160c8c28676">neml2::Scalar::full</a>(200.0)},</div>
<div class="line">                      {<span class="stringliteral">&quot;nu&quot;</span>, <a class="code hl_function" href="classneml2_1_1PrimitiveTensor.html#a02437fba177741bfc48dc160c8c28676">neml2::Scalar::full</a>(0.25)}});</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
