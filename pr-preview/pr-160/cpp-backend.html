<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NEML2: C++ Backend</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams','[tex]/physics','[tex]/boldsymbol']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams','physics','boldsymbol']
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NEML2<span id="projectnumber">&#160;1.4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('cpp-backend.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">C++ Backend</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md34">Loading a model from an input file</a></li>
<li class="level1"><a href="#autotoc_md35">Evaluate the model</a></li>
<li class="level1"><a href="#inference-mode">Inference Mode</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2neml2_2neml2_2doc_2content_2user_2cpp"></a></p>
<h1><a class="anchor" id="autotoc_md34"></a>
Loading a model from an input file</h1>
<p>The following input file defines a linear isotropic elasticity material model:</p>
<div class="fragment"><div class="line">[Models]</div>
<div class="line">  [model]</div>
<div class="line">    type = LinearIsotropicElasticity</div>
<div class="line">    youngs_modulus = 100</div>
<div class="line">    poisson_ratio = 0.3</div>
<div class="line">    strain = <span class="stringliteral">&#39;forces/E&#39;</span></div>
<div class="line">    stress = <span class="stringliteral">&#39;state/S&#39;</span></div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p>The input file defines two parameters: Young's modulus of 100 and Poisson's ratio of 0.3. While optional, the input file also sets the variable names of strain and stress to be "forces/E" and "state/S", respectively (refer to the documentation on <a class="el" href="system-tensors.html#tensor-labeling">tensor labeling</a> for variable naming conventions).</p>
<p>Assuming the above input file is named "input_file.i", the C++ code snippet below parses the input file and loads the material model (into the heap).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/base/Parser.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/base/Factory.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/tensors.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceneml2.html">neml2</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_class" href="classneml2_1_1CrossRef.html">main</a>() {</div>
<div class="line">  load_model(<span class="stringliteral">&quot;input.i&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> &amp; model = get_model(<span class="stringliteral">&quot;model&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassneml2_1_1CrossRef_html"><div class="ttname"><a href="classneml2_1_1CrossRef.html">neml2::CrossRef</a></div><div class="ttdoc">The wrapper (decorator) for cross-referencing unresolved values at parse time.</div><div class="ttdef"><b>Definition</b> CrossRef.h:53</div></div>
<div class="ttc" id="anamespaceneml2_html"><div class="ttname"><a href="namespaceneml2.html">neml2</a></div><div class="ttdef"><b>Definition</b> CrossRef.cxx:30</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md35"></a>
Evaluate the model</h1>
<p>Suppose we want to perform 3 material updates simultaneously, the model should be initialized using the <a class="el" href="classneml2_1_1Model.html#add0302a95f0f0bb555a626603ef86472" title="Allocate storage and setup views for all the variables of this model and recursively all of the sub-m...">neml2::Model::reinit</a> method with the correct batch shape (refer to the <a class="el" href="system-tensors.html">tensor system documentation</a> for more detailed explanation on the term "batch"):</p>
<div class="fragment"><div class="line">model.reinit({3});</div>
</div><!-- fragment --><p>Finally, the following code constructs the 3 input strains <code>in</code> and performs 3 material updates <em>simultaneously</em>. Output stresses are stored in the tensor <code>out</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> <a class="code hl_class" href="classneml2_1_1CrossRef.html">in</a> = LabeledVector::empty({3}, {model.input_axis()});</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classneml2_1_1CrossRef.html">in</a>.batch_index_put({0}, SR2::fill(0.1, 0.2, 0.3, -0.1, -0.1, 0.2));</div>
<div class="line"><a class="code hl_class" href="classneml2_1_1CrossRef.html">in</a>.batch_index_put({1}, SR2::fill(0.2, 0.2, 0.1, -0.1, -0.2, -0.5));</div>
<div class="line"><a class="code hl_class" href="classneml2_1_1CrossRef.html">in</a>.batch_index_put({2}, SR2::fill(0.3, -0.2, 0.05, -0.1, -0.3, 0.1));</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> <a class="code hl_class" href="classneml2_1_1CrossRef.html">out</a> = model.value(<a class="code hl_class" href="classneml2_1_1CrossRef.html">in</a>);</div>
</div><!-- fragment --><h1><a class="anchor" id="inference-mode"></a>
Inference Mode</h1>
<p>By default, inference mode is disabled. During every model evaluation, variables are re-allocated, and variable views are reconfigured. This default behavior avoids in-place operations and is mandatory to use PyTorch automatic differentiation (AD) (i.e. for parameter gradient or AD forward operator).</p>
<p>The default behavior is flexible. However, if PyTorch AD is not needed, i.e., once the model is fully calibrated, the variable reallocation and view reconfiguration can be skipped. The inference mode is designed for that purpose.</p>
<p>When inference mode is activated, no function graph is built, tensor version numbers are not incremented, and the variables and variable views are setup once and for all, all of which speed up evaluation. See <a href="https://pytorch.org/cppdocs/notes/inference_mode.html">https://pytorch.org/cppdocs/notes/inference_mode.html</a> for more details.</p>
<p>To enable inference mode, use the optional second argument passed to <code><a class="el" href="namespaceneml2.html#ac3b81673a16c8a5de7e361a938aa89ae" title="A convenient function to manufacture a neml2::Model.">neml2::get_model</a></code>, i.e. </p><div class="fragment"><div class="line"><span class="keyword">auto</span> &amp; model = get_model(<span class="stringliteral">&quot;model&quot;</span>, <span class="comment">/*inference_mode=*/</span><span class="keyword">true</span>);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
