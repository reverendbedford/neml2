<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NEML2: C++ Backend</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams','[tex]/physics','[tex]/boldsymbol']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams','physics','boldsymbol']
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NEML2<span id="projectnumber">&#160;1.4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('cpp-backend.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">C++ Backend</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md38">Loading a model from an input file</a></li>
<li class="level1"><a href="#autotoc_md39">Evaluate the model</a></li>
<li class="level1"><a href="#disable-ad">Enable/disable automatic differentiation</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2neml2_2neml2_2doc_2content_2user_2cpp"></a></p>
<h1><a class="anchor" id="autotoc_md38"></a>
Loading a model from an input file</h1>
<p>The following input file defines a linear isotropic elasticity material model:</p>
<div class="fragment"><div class="line">[Models]</div>
<div class="line">  [model]</div>
<div class="line">    type = LinearIsotropicElasticity</div>
<div class="line">    youngs_modulus = 100</div>
<div class="line">    poisson_ratio = 0.3</div>
<div class="line">    strain = <span class="stringliteral">&#39;forces/E&#39;</span></div>
<div class="line">    stress = <span class="stringliteral">&#39;state/S&#39;</span></div>
<div class="line">  []</div>
<div class="line">[]</div>
</div><!-- fragment --><p>The input file defines two parameters: Young's modulus of 100 and Poisson's ratio of 0.3. While optional, the input file also sets the variable names of strain and stress to be "forces/E" and "state/S", respectively (refer to the documentation on <a class="el" href="system-tensors.html#tensor-labeling">tensor labeling</a> for variable naming conventions).</p>
<p>Assuming the above input file is named "input_file.i", the C++ code snippet below parses the input file and loads the material model (into the heap).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;neml2/base/Factory.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/models/Model.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;neml2/tensors/tensors.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line">  <span class="keyword">auto</span> &amp; model = <a class="code hl_function" href="namespaceneml2.html#a0e8c7aeae6d7c24a44a404965d5b5fa3">neml2::load_model</a>(<span class="stringliteral">&quot;input.i&quot;</span>, <span class="stringliteral">&quot;model&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceneml2_html_a0e8c7aeae6d7c24a44a404965d5b5fa3"><div class="ttname"><a href="namespaceneml2.html#a0e8c7aeae6d7c24a44a404965d5b5fa3">neml2::load_model</a></div><div class="ttdeci">Model &amp; load_model(const std::filesystem::path &amp;path, const std::string &amp;mname, bool enable_ad)</div><div class="ttdoc">A convenient function to load an input file and get a model.</div><div class="ttdef"><b>Definition</b> Factory.cxx:69</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md39"></a>
Evaluate the model</h1>
<p>Suppose we want to perform 3 material updates simultaneously, the model should be initialized using the <a class="el" href="classneml2_1_1Model.html#add0302a95f0f0bb555a626603ef86472" title="Allocate storage and setup views for all the variables of this model and recursively all of the sub-m...">neml2::Model::reinit</a> method with the correct batch shape (refer to the <a class="el" href="system-tensors.html">tensor system documentation</a> for more detailed explanation on the term "batch"):</p>
<div class="fragment"><div class="line">model.reinit({3});</div>
</div><!-- fragment --><p>Finally, the following code constructs the 3 input strains <code>in</code> and performs 3 material updates <em>simultaneously</em>. Output stresses are stored in the tensor <code>out</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> in = <a class="code hl_function" href="classneml2_1_1LabeledTensor.html#a8f4d8eff289238246009582aebb4f1b8">neml2::LabeledVector::empty</a>({3}, {model.input_axis()});</div>
<div class="line"> </div>
<div class="line">in.batch_index_put_({0}, <a class="code hl_function" href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a>(0.1, 0.2, 0.3, -0.1, -0.1, 0.2));</div>
<div class="line">in.batch_index_put_({1}, <a class="code hl_function" href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a>(0.2, 0.2, 0.1, -0.1, -0.2, -0.5));</div>
<div class="line">in.batch_index_put_({2}, <a class="code hl_function" href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a>(0.3, -0.2, 0.05, -0.1, -0.3, 0.1));</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> out = model.value(in);</div>
<div class="ttc" id="aclassneml2_1_1LabeledTensor_html_a8f4d8eff289238246009582aebb4f1b8"><div class="ttname"><a href="classneml2_1_1LabeledTensor.html#a8f4d8eff289238246009582aebb4f1b8">neml2::LabeledTensor&lt; LabeledVector, 1 &gt;::empty</a></div><div class="ttdeci">static LabeledVector empty(TensorShapeRef batch_shape, const std::array&lt; const LabeledAxis *, D &gt; &amp;axes, const torch::TensorOptions &amp;options=default_tensor_options())</div><div class="ttdoc">Setup new empty storage.</div><div class="ttdef"><b>Definition</b> LabeledTensor.cxx:96</div></div>
<div class="ttc" id="aclassneml2_1_1SR2_html_af267747e919faf52e046ee51b493ce0d"><div class="ttname"><a href="classneml2_1_1SR2.html#af267747e919faf52e046ee51b493ce0d">neml2::SR2::fill</a></div><div class="ttdeci">static SR2 fill(const Real &amp;a, const torch::TensorOptions &amp;options=default_tensor_options())</div><div class="ttdoc">Fill the diagonals with a11 = a22 = a33 = a.</div><div class="ttdef"><b>Definition</b> SR2.cxx:46</div></div>
</div><!-- fragment --><h1><a class="anchor" id="disable-ad"></a>
Enable/disable automatic differentiation</h1>
<p>By default, automatic differentiation is enabled. During every model evaluation, variables are re-allocated, and variable views are reconfigured. This default behavior avoids in-place operations and is mandatory to use PyTorch automatic differentiation (AD) (i.e. for parameter gradient or AD forward operator).</p>
<p>The default behavior is flexible and powerful. However, if PyTorch AD is not needed, i.e., once the model is fully calibrated/trained, the variable reallocation and view reconfiguration can be skipped. The <code>enable_AD</code> option is designed for that purpose.</p>
<p>When AD is disabled, no function graph is built, tensor version numbers are not incremented, and the variables and variable views are setup once and for all, all of which speed up evaluation. Furthermore, this mode is fully compatible with PyTorch's <a href="https://pytorch.org/cppdocs/notes/inference_mode.html">inference mode</a></p>
<p>To disable AD, use the optional second argument passed to <code><a class="el" href="namespaceneml2.html#a78df4c4065e754df9577bd89ee062af8" title="A convenient function to manufacture a neml2::Model.">neml2::get_model</a></code>, i.e. </p><div class="fragment"><div class="line"><span class="keyword">auto</span> &amp; model = <a class="code hl_function" href="namespaceneml2.html#a78df4c4065e754df9577bd89ee062af8">neml2::get_model</a>(<span class="stringliteral">&quot;model&quot;</span>, <span class="comment">/*disable_AD=*/</span><span class="keyword">true</span>);</div>
<div class="ttc" id="anamespaceneml2_html_a78df4c4065e754df9577bd89ee062af8"><div class="ttname"><a href="namespaceneml2.html#a78df4c4065e754df9577bd89ee062af8">neml2::get_model</a></div><div class="ttdeci">Model &amp; get_model(const std::string &amp;mname, bool enable_ad, bool force_create)</div><div class="ttdoc">A convenient function to manufacture a neml2::Model.</div><div class="ttdef"><b>Definition</b> Factory.cxx:59</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
